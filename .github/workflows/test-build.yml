name: Test Template Build

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check source files
      run: |
        echo "=== Repository structure ==="
        ls -la
        echo ""
        echo "=== .growthkit structure ==="
        ls -laR .growthkit/
        echo ""
        echo "=== Checking for required files ==="
        test -d .growthkit/memory && echo "✓ .growthkit/memory exists" || echo "✗ .growthkit/memory missing"
        test -d .growthkit/templates && echo "✓ .growthkit/templates exists" || echo "✗ .growthkit/templates missing"
        test -d .growthkit/templates/commands && echo "✓ .growthkit/templates/commands exists" || echo "✗ .growthkit/templates/commands missing"
        test -d .growthkit/scripts/bash && echo "✓ .growthkit/scripts/bash exists" || echo "✗ .growthkit/scripts/bash missing"
        test -d .growthkit/scripts/powershell && echo "✓ .growthkit/scripts/powershell exists" || echo "✗ .growthkit/scripts/powershell missing"
        echo ""
        echo "=== Template commands ==="
        ls -la .growthkit/templates/commands/

    - name: Test build single variant
      run: |
        echo "=== Testing minimal build ==="
        mkdir -p test-output
        cd test-output

        # Create a simple test structure
        mkdir -p growthkit-test/.growthkit/memory
        echo "Test constitution" > growthkit-test/.growthkit/memory/constitution.md

        # Try to create ZIP
        if command -v zip &> /dev/null; then
          echo "✓ zip command available"
          zip -r growthkit-test.zip growthkit-test/
          ls -lh growthkit-test.zip
        else
          echo "✗ zip command not found!"
          exit 1
        fi

    - name: Test full build script
      run: |
        chmod +x .github/workflows/scripts/create-release-packages.sh
        echo "=== Running build script ==="
        bash -x .github/workflows/scripts/create-release-packages.sh "v0.2.test" 2>&1 | head -200
        echo ""
        echo "=== Checking output ==="
        ls -la .genreleases/ || echo "No .genreleases directory!"
        if [ -d .genreleases/ ]; then
          echo "File count: $(ls -1 .genreleases/*.zip 2>/dev/null | wc -l)"
        fi
