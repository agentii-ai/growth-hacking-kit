name: CI - Template Validation

on:
  pull_request:
    paths:
      - '.growthkit/**'
      - 'memory/**'
      - 'scripts/**'
      - 'templates/**'
      - '.github/workflows/scripts/**'
      - 'scripts/validate-templates.sh'
  workflow_dispatch:

jobs:
  validate-templates:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python (for potential linting)
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Build templates
      run: |
        chmod +x .github/workflows/scripts/create-release-packages.sh
        .github/workflows/scripts/create-release-packages.sh v0.0.0-ci-test

    - name: Validate templates
      run: |
        chmod +x scripts/validate-templates.sh
        ./scripts/validate-templates.sh .genreleases/

    - name: Lint bash scripts
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck
        echo "Linting bash scripts..."
        find .growthkit/scripts/bash -name "*.sh" -type f -exec shellcheck {} \; || true
        find .github/workflows/scripts -name "*.sh" -type f -exec shellcheck {} \; || true
        find scripts -name "*.sh" -type f -exec shellcheck {} \; || true

    - name: Lint PowerShell scripts
      shell: pwsh
      run: |
        Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
        Write-Host "Linting PowerShell scripts..."
        $psFiles = Get-ChildItem -Path .growthkit/scripts/powershell -Filter *.ps1 -Recurse
        foreach ($file in $psFiles) {
          Write-Host "Analyzing: $($file.FullName)"
          Invoke-ScriptAnalyzer -Path $file.FullName -Severity Warning
        }

    - name: Upload validation results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: validation-results
        path: .genreleases/

  test-template-extraction:
    runs-on: ubuntu-latest
    needs: validate-templates
    strategy:
      matrix:
        agent: [claude, cursor-agent, windsurf]
        script: [sh, ps]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build template for ${{ matrix.agent }}-${{ matrix.script }}
      run: |
        chmod +x .github/workflows/scripts/create-release-packages.sh
        export GENRELEASES_DIR=".test-templates"
        .github/workflows/scripts/create-release-packages.sh v0.0.0-test

    - name: Extract and verify template structure
      run: |
        mkdir -p /tmp/extract-test
        ZIP_FILE=".test-templates/growthkit-template-${{ matrix.agent }}-${{ matrix.script }}-v0.0.0-test.zip"

        if [ ! -f "$ZIP_FILE" ]; then
          echo "❌ Template ZIP not found: $ZIP_FILE"
          exit 1
        fi

        unzip -q "$ZIP_FILE" -d /tmp/extract-test

        # Verify structure
        echo "Verifying directory structure..."
        EXTRACT_DIR=$(find /tmp/extract-test -mindepth 1 -maxdepth 1 -type d | head -1)

        if [ ! -d "$EXTRACT_DIR/.growthkit" ]; then
          echo "❌ Missing .growthkit/ directory"
          exit 1
        fi

        if [ ! -f "$EXTRACT_DIR/.growthkit/memory/constitution.md" ]; then
          echo "❌ Missing constitution.md"
          exit 1
        fi

        echo "✅ Template structure verified for ${{ matrix.agent }}-${{ matrix.script }}"

  summary:
    runs-on: ubuntu-latest
    needs: [validate-templates, test-template-extraction]
    if: always()
    steps:
    - name: CI Summary
      run: |
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "CI Validation Summary"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "✓ Template validation: ${{ needs.validate-templates.result }}"
        echo "✓ Template extraction: ${{ needs.test-template-extraction.result }}"
        echo ""
        if [ "${{ needs.validate-templates.result }}" == "success" ] && [ "${{ needs.test-template-extraction.result }}" == "success" ]; then
          echo "✅ All CI checks passed!"
        else
          echo "❌ Some CI checks failed"
          exit 1
        fi
